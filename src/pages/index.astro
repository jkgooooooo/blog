---
import { getCollection } from "astro:content";
import Layout from "../layouts/Layout.astro";

const rawBase = import.meta.env.BASE_URL ?? "/";
const basePath =
  rawBase === "/" ? "/" : `/${rawBase.replace(/^\/+|\/+$/g, "")}/`;

const categoryToSlug = (category) =>
  category
    .toLowerCase()
    .replace(/[^a-z0-9가-힣\s-]/g, "")
    .trim()
    .replace(/\s+/g, "-") || "general";

const posts = (await getCollection("blog", ({ data }) => !data.draft)).sort(
  (a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf(),
);

const latestPosts = posts.slice(0, 6);
const categories = posts.reduce((acc, post) => {
  const category = post.data.category || "General";
  acc[category] = (acc[category] || 0) + 1;
  return acc;
}, {});
---

<Layout title="JKGOOOOOOO Tech Blog" description="IT 기술 정리와 개발 기록">
  <main class="home">
    <header class="intro">
      <h1>JKGOOOOOOO Blog</h1>
    </header>

    <section class="home-section">
      <div class="section-head">
        <h2>최신 글</h2>
        <a href={`${basePath}posts/`}>모든 글 보기</a>
      </div>
      <ul class="post-list">
        {
          latestPosts.map((post) => (
            <li>
              <a class="post-cell" href={`${basePath}${post.slug}/`}>
                <h3>{post.data.title}</h3>
                <p>{post.data.description || "요약 설명을 추가해 주세요."}</p>
                <div class="meta">
                  <span class="cat">{post.data.category || "General"}</span>
                  <time datetime={new Date(post.data.pubDate).toISOString()}>
                    {new Date(post.data.pubDate).toLocaleDateString("ko-KR")}
                  </time>
                </div>
              </a>
            </li>
          ))
        }
      </ul>
    </section>

    <section class="home-section">
      <div class="section-head">
        <h2>카테고리</h2>
        <a href={`${basePath}categories/`}>카테고리 페이지</a>
      </div>
      <ul class="category-list">
        {Object.entries(categories).map(([name, count]) => (
          <li>
            <a href={`${basePath}categories/${categoryToSlug(name)}/`}>
              <span>{name}</span>
              <small>{count}</small>
            </a>
          </li>
        ))}
      </ul>
    </section>
  </main>
</Layout>

<style>
  .intro h1 {
    font-size: clamp(2rem, 5vw, 2.8rem);
    line-height: 1.06;
    margin-bottom: 0.75rem;
  }

  .intro p {
    margin: 0;
    color: #a1a1aa;
    line-height: 1.8;
  }

  .home-section {
    margin-top: 2.2rem;
  }

  .section-head {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    gap: 0.6rem;
    padding-bottom: 0.55rem;
  }

  h2 {
    font-size: 1rem;
  }

  .section-head a {
    font-size: 0.85rem;
    color: #a1a1aa;
    text-decoration: none;
    font-weight: 600;
  }

  .section-head a:hover {
    color: #f4f4f5;
  }

  .post-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .post-cell {
    display: block;
    text-decoration: none;
    padding: 1rem 0;
    transition: background-color 140ms ease;
  }

  .post-cell:hover {
    background: #111113;
  }

  .post-list h3 {
    font-size: 1.22rem;
    line-height: 1.32;
    margin-bottom: 0.32rem;
  }

  .post-list p {
    margin: 0;
    color: #a1a1aa;
    line-height: 1.75;
  }

  .meta {
    margin-top: 0.5rem;
    display: flex;
    gap: 0.65rem;
    align-items: center;
    font-size: 0.82rem;
  }

  .cat {
    color: #60a5fa;
    font-weight: 700;
  }

  .meta time {
    color: #a1a1aa;
    font-weight: 600;
  }

  .category-list {
    list-style: none;
    margin: 0.8rem 0 0;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem 1rem;
  }

  .category-list li a {
    text-decoration: none;
    font-weight: 700;
    color: #d4d4d8;
    display: inline-flex;
    align-items: baseline;
    gap: 0.4rem;
  }

  .category-list li a:hover span {
    text-decoration: underline;
  }

  .category-list small {
    color: #a1a1aa;
    font-size: 0.76rem;
    font-weight: 700;
  }
</style>
