---
import { getCollection, render } from "astro:content";
import GiscusComments from "../components/GiscusComments.astro";
import Layout from "../layouts/Layout.astro";
const includeDrafts = import.meta.env.DEV;

export async function getStaticPaths() {
  const includeDrafts = import.meta.env.DEV;
  const posts = await getCollection("blog", ({ data }) => includeDrafts || !data.draft);
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);
const description = post.data.description?.trim() || `${post.data.title} 글 요약`;
const category = post.data.category || "General";
const displayTags = (post.data.tags?.length ? post.data.tags : [category]).slice(0, 8);
const categorySlug = category
  .toLowerCase()
  .replace(/[^a-z0-9가-힣\s-]/g, "")
  .trim()
  .replace(/\s+/g, "-") || "general";
const rawBase = import.meta.env.BASE_URL ?? "/";
const basePath =
  rawBase === "/" ? "/" : `/${rawBase.replace(/^\/+|\/+$/g, "")}/`;
const siteUrl = Astro.site ?? new URL("https://jkgooooooo.github.io");
const requestedCanonical = post.data.canonicalURL?.trim();
const localCanonical = new URL(`${basePath}${post.slug}/`, siteUrl).toString();
const canonical = (() => {
  if (!requestedCanonical) return localCanonical;
  try {
    const parsed = new URL(requestedCanonical);
    return parsed.origin === siteUrl.origin ? parsed.toString() : localCanonical;
  } catch {
    return localCanonical;
  }
})();
const publishedTime = new Date(post.data.pubDate).toISOString();
const wordCount = (post.body || "").split(/\s+/).filter(Boolean).length;
const readingMinutes = Math.max(
  1,
  Math.ceil(wordCount / 220),
);
const leadText =
  post.data.description?.trim() || (wordCount > 0 && wordCount < 90
    ? "핵심만 짧게 정리한 노트입니다."
    : null);

const hasBody = Boolean(post.body?.trim());
const orderedPosts = (await getCollection("blog", ({ data }) => includeDrafts || !data.draft))
  .slice()
  .sort((a, b) => {
    const dateDiff = new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf();
    if (dateDiff !== 0) return dateDiff;
    return a.slug.localeCompare(b.slug, "ko");
  });
const currentTags = post.data.tags ?? [];
const scoredPosts = orderedPosts
  .filter((item) => item.slug !== post.slug)
  .map((item) => {
    const tags = item.data.tags ?? [];
    const sharedTags = tags.filter((tag) => currentTags.includes(tag));
    const sameCategory = (item.data.category ?? "General") === category;
    return { item, sharedTags, sharedCount: sharedTags.length, sameCategory };
  });

let relatedPosts = scoredPosts
  .filter((entry) => entry.sharedCount > 0)
  .sort((a, b) => {
    if (b.sharedCount !== a.sharedCount) return b.sharedCount - a.sharedCount;
    if (b.sameCategory !== a.sameCategory) return Number(b.sameCategory) - Number(a.sameCategory);
    return new Date(b.item.data.pubDate).valueOf() - new Date(a.item.data.pubDate).valueOf();
  })
  .slice(0, 5);

if (!relatedPosts.length) {
  relatedPosts = scoredPosts
    .filter((entry) => entry.sameCategory)
    .sort(
      (a, b) =>
        new Date(b.item.data.pubDate).valueOf() - new Date(a.item.data.pubDate).valueOf(),
    )
    .slice(0, 5);
}

const imagePath = post.data.ogImage?.trim() || `${basePath}og-default.svg`;
const imageUrl = new URL(imagePath, siteUrl).toString();
const keywords = Array.from(
  new Set([category, ...(post.data.tags ?? [])].map((v) => String(v).trim()).filter(Boolean)),
);
const articleJsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: post.data.title,
  description,
  datePublished: publishedTime,
  dateModified: publishedTime,
  url: canonical,
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": canonical,
  },
  inLanguage: "ko-KR",
  image: [imageUrl],
  author: {
    "@type": "Person",
    name: "JKGOOOOOOO",
  },
  publisher: {
    "@type": "Organization",
    name: "JKGOOOOOOO Blog",
  },
  keywords,
};
---

<Layout
  title={`${post.data.title} | JKGOOOOOOO Blog`}
  description={description}
  canonical={canonical}
  type="article"
  publishedTime={publishedTime}
  jsonLd={articleJsonLd}
>
  <main id="main-content" class="post-page">
    {hasBody ? (
      <div class="read-progress-wrap" aria-hidden="true">
        <span class="read-progress-bar" data-read-progress></span>
      </div>
    ) : null}
    <header class="post-head">
      <a class="back" href={`${basePath}posts/`}>← 모든 글 보기</a>
      <h1>{post.data.title}</h1>
      <div class="meta">
        <a class="meta-category" href={`${basePath}categories/${categorySlug}/`}>
          {category}
        </a>
        <span class="meta-sep" aria-hidden="true">·</span>
        <span>{readingMinutes} min</span>
        <span class="meta-sep" aria-hidden="true">·</span>
        <time datetime={publishedTime}>{new Date(post.data.pubDate).toLocaleDateString("ko-KR")}</time>
      </div>
      {displayTags.length ? (
        <div class="meta-tags-row" aria-label="태그">
          {displayTags.map((tag) => (
            <span class="meta-tag-chip">#{tag}</span>
          ))}
        </div>
      ) : null}
    </header>

    <div class="section-divider" aria-hidden="true"></div>

    {hasBody ? (
      <>
        {leadText ? (
          <section class="lead" aria-label="글 요약">
            <p>{leadText}</p>
          </section>
        ) : null}
        <article class="post-body">
          <Content />
        </article>
      </>
    ) : null}

    {relatedPosts.length ? (
      <section class="related-section" aria-label="관련 글">
        <h2>관련 글</h2>
        <ul class="related-list">
          {relatedPosts.map(({ item, sharedTags }) => {
            const tagsToShow = sharedTags.length
              ? sharedTags
              : (item.data.tags?.length ? item.data.tags : [item.data.category ?? "General"]);
            return (
              <li>
                <a href={`${basePath}${item.slug}/`} class="related-link">
                  <div class="related-main">
                    <h3>{item.data.title}</h3>
                    <p class="related-tags"># {tagsToShow.join(", ")}</p>
                  </div>
                  <time datetime={new Date(item.data.pubDate).toISOString()}>
                    {new Date(item.data.pubDate).toLocaleDateString("ko-KR")}
                  </time>
                </a>
              </li>
            );
          })}
        </ul>
      </section>
    ) : null}

    <GiscusComments />
  </main>
</Layout>

<script is:inline>
  (() => {
    const progressEl = document.querySelector("[data-read-progress]");
    const articleEl = document.querySelector(".post-body");
    const footerEl = document.querySelector(".site-footer");
    const mobileQuery = window.matchMedia("(max-width: 640px)");
    let lastY = window.scrollY;

    const updateProgress = () => {
      if (!progressEl || !articleEl) return;
      const articleTop = articleEl.getBoundingClientRect().top + window.scrollY;
      const start = articleTop - 48;
      const end = start + articleEl.offsetHeight - window.innerHeight * 0.65;
      const raw = (window.scrollY - start) / Math.max(1, end - start);
      const progress = Math.max(0, Math.min(1, raw));
      progressEl.style.transform = `scaleX(${progress})`;
    };

    const updateFooterVisibility = () => {
      if (!footerEl) return;
      if (!mobileQuery.matches) {
        footerEl.classList.remove("is-hidden");
        return;
      }

      const y = window.scrollY;
      const delta = y - lastY;
      if (y > 84 && delta > 4) footerEl.classList.add("is-hidden");
      else if (delta < -4 || y < 40) footerEl.classList.remove("is-hidden");
      lastY = y;
    };

    const onScroll = () => {
      updateProgress();
      updateFooterVisibility();
    };

    updateProgress();
    updateFooterVisibility();
    window.addEventListener("scroll", onScroll, { passive: true });
    window.addEventListener("resize", updateProgress);
  })();
</script>

<style>
  .post-page {
    --space-header-body: clamp(1.5rem, 3.2vw, 2rem);
    --space-body-related: clamp(2.2rem, 6vw, 3.2rem);
    --space-paragraph: 1rem;
  }

  .read-progress-wrap {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    z-index: 40;
    pointer-events: none;
  }

  .read-progress-bar {
    display: block;
    width: 100%;
    height: 100%;
    transform-origin: 0 50%;
    transform: scaleX(0);
    background: linear-gradient(90deg, #38bdf8, #60a5fa);
  }

  .post-head {
    margin-bottom: 1.45rem;
  }

  .back {
    color: #d4d4d8;
    text-decoration: none;
    font-size: 0.88rem;
    font-weight: 700;
    display: inline-block;
    padding: 0.42rem 0.7rem;
    border-radius: 999px;
    background: var(--surface);
    box-shadow: inset 0 0 0 1px var(--line);
    transition:
      background-color 120ms ease,
      color 120ms ease;
  }

  .back:hover {
    background: var(--surface-hover);
    color: #f4f4f5;
  }

  h1 {
    margin-top: 0.62rem;
    font-size: clamp(1.95rem, 5vw, 2.8rem);
    line-height: 1.1;
  }

  .meta {
    margin-top: 0.72rem;
    display: flex;
    gap: 0.45rem;
    align-items: center;
    font-size: 0.82rem;
    color: #94a3b8;
    flex-wrap: wrap;
  }

  .meta-category {
    color: #cbd5e1;
    text-decoration: none;
    font-weight: 600;
    border-radius: 999px;
    background: var(--surface-soft);
    padding: 0.18rem 0.5rem;
  }

  .meta time {
    color: #94a3b8;
    font-weight: 600;
  }

  .meta span {
    color: #94a3b8;
    font-weight: 600;
  }

  .meta-sep {
    color: #64748b;
    transform: translateY(-0.01em);
  }

  .meta-tags-row {
    margin-top: 0.55rem;
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }

  .meta-tag-chip {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    padding: 0.18rem 0.5rem;
    background: var(--surface-soft);
    color: #b6c2d1;
    font-size: 0.74rem;
    line-height: 1.2;
    font-weight: 600;
  }

  .section-divider {
    height: 1px;
    background: var(--line);
    margin-bottom: var(--space-header-body);
  }

  .lead {
    margin: 0 0 1.2rem;
    max-width: 74ch;
  }

  .lead p {
    margin: 0;
    color: #cbd5e1;
    line-height: 1.8;
    font-size: 1rem;
  }

  .post-body {
    padding: 0;
    background: transparent;
    border: 0;
    border-radius: 0;
    box-shadow: none;
  }

  .post-body > :global(p) {
    background: transparent;
    border: 0;
    border-radius: 0;
    box-shadow: none;
    padding: 0;
  }

  .post-body :global(h2),
  .post-body :global(h3) {
    margin: 1.85rem 0 0.72rem;
    line-height: 1.34;
  }

  .post-body :global(h2) {
    font-size: 1.45rem;
  }

  .post-body :global(h3) {
    font-size: 1.18rem;
  }

  .post-body :global(p),
  .post-body :global(li) {
    margin: 0;
    line-height: 1.92;
    color: #d4d4d8;
    font-size: 1.02rem;
    max-width: 70ch;
  }

  .post-body :global(a) {
    color: #93c5fd;
    text-decoration: underline;
    text-underline-offset: 0.18em;
    text-decoration-thickness: 1px;
    cursor: pointer;
  }

  .post-body :global(a:hover) {
    color: #bfdbfe;
  }

  .post-body :global(p + p),
  .post-body :global(p + ul),
  .post-body :global(p + ol),
  .post-body :global(ul + p),
  .post-body :global(ol + p) {
    margin-top: var(--space-paragraph);
  }

  .post-body :global(ul),
  .post-body :global(ol) {
    padding-left: 1.2rem;
  }

  .post-body :global(table) {
    width: min(100%, 70ch);
    border-collapse: collapse;
    margin: 1.1rem 0;
    border: 1px solid var(--line);
    border-radius: 10px;
    overflow: hidden;
    background: var(--surface-soft);
    font-size: 0.96rem;
  }

  .post-body :global(th),
  .post-body :global(td) {
    padding: 0.72rem 0.82rem;
    text-align: left;
    vertical-align: top;
    line-height: 1.6;
  }

  .post-body :global(th) {
    color: #e2e8f0;
    font-weight: 700;
    background: rgba(148, 163, 184, 0.08);
    border-bottom: 1px solid var(--line);
  }

  .post-body :global(td) {
    color: #d4d4d8;
  }

  .post-body :global(tr + tr td) {
    border-top: 1px solid rgba(148, 163, 184, 0.2);
  }

  .post-body :global(blockquote) {
    margin: 1.15rem 0;
    padding: 0.9rem 1rem;
    background: var(--surface-hover);
    border-radius: 10px;
  }

  .post-body :global(code) {
    font-family: "Manrope", "SFMono-Regular", Menlo, Monaco, Consolas, monospace;
    background: var(--surface-hover);
    border-radius: 6px;
    padding: 0.08rem 0.32rem;
    font-size: 0.9em;
  }

  .post-body :global(pre) {
    background: #0f172a;
    border-radius: 10px;
    color: #e2e8f0;
    padding: 1rem;
    overflow-x: auto;
    margin: 1.1rem 0;
  }

  .post-body :global(pre code) {
    background: transparent;
    padding: 0;
    color: inherit;
  }

  .related-section {
    margin-top: var(--space-body-related);
  }

  .related-section h2 {
    margin: 0 0 0.9rem;
    font-size: 1.2rem;
  }

  .related-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.4rem;
  }

  .related-link {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.7rem 1rem;
    align-items: start;
    text-decoration: none;
    padding: 0.82rem 0.88rem;
    border-radius: 10px;
    transition:
      background-color 120ms ease,
      box-shadow 120ms ease;
  }

  .related-link:hover {
    background: var(--surface-hover);
    box-shadow: inset 0 0 0 1px var(--line);
  }

  .related-main h3 {
    margin: 0;
    font-size: 1.08rem;
    line-height: 1.35;
  }

  .related-tags {
    margin: 0.28rem 0 0;
    font-size: 0.86rem;
    color: #94a3b8;
    line-height: 1.45;
  }

  .related-link time {
    margin-top: 0.04rem;
    color: #94a3b8;
    font-size: 0.85rem;
    font-weight: 500;
    white-space: nowrap;
  }

  @media (max-width: 640px) {
    .related-link {
      grid-template-columns: 1fr;
      gap: 0.4rem;
    }

    .related-link time {
      font-size: 0.8rem;
    }

    h1 {
      font-size: clamp(1.8rem, 9vw, 2.3rem);
    }
  }
</style>
